<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trajectory Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f0f0f;
            color: #ebebeb;
            overflow: hidden;
            height: 100vh;
        }

        /* Entry Page Styles */
        #entry-page {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .entry-title {
            font-size: 32px;
            margin-bottom: 40px;
            color: #b4dcff;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }

        .preview-item {
            aspect-ratio: 1;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.3s, transform 0.3s;
        }

        .preview-item:hover {
            border-color: #4a9eff;
            transform: scale(1.05);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Main Container Styles */
        .container {
            display: flex;
            height: 100vh;
            display: none; /* Hidden by default, shown after entry selection */
        }

        .left-panel {
            width: 50%;
            background: #14161a;
            padding: 28px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            width: 50%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .right-panel-top {
            flex: 1.0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            position: relative;
            border-bottom: 2px solid #464650;
            min-height: 0; /* Prevent layout shift */
        }

        .right-panel-top-left {
            width: 50%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #464650;
            padding: 10px;
        }

        .right-panel-top-right {
            width: 50%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .right-panel-bottom {
            flex: 1.0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 0; /* Ensure flex child can shrink */
        }

        .section {
            margin-bottom: 18px;
        }

        .section-label {
            color: #b4dcff;
            font-size: 22px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .thought-content {
            color: #ebebeb;
            font-size: 18px;
            line-height: 1.6;
            min-height: 50px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .separator {
            height: 2px;
            background: #464650;
            margin: 18px 0;
        }

        .code-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .code-container {
            flex: 1;
            background: #101012;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
        }

        .code-content {
            padding: 8px;
            overflow-y: auto;
            height: 100%;
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .code-content pre {
            margin: 0;
            padding: 0;
        }

        .code-content code {
            display: block;
            color: #dcdcdc;
        }

        .image-container {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
        }

        .image-container img {
            max-width: 70%;
            max-height: 70%;
            object-fit: contain;
        }

        /* Ensure bottom image container displays images at same size as top */
        #image-container-bottom {
            width: 100%;
            height: 100%;
        }

        #image-container-bottom img {
            max-width: 70%;
            max-height: 70%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .loading-gif {
            width: 100px;
            height: 100px;
        }

        .loading-text {
            margin-top: 20px;
            color: #888;
            font-size: 18px;
        }

        .video-container {
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container video {
            max-width: 70%;
            max-height: 70%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 15px;
        }

        .download-blender-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: #3a8eef;
        }

        .btn:disabled {
            background: #464650;
            cursor: not-allowed;
        }

        .btn-Investigate {
            background: #ffa500;
        }

        .btn-Investigate:hover:not(:disabled) {
            background: #ff9500;
        }

        .btn-resume {
            background: #00c853;
        }

        .btn-resume:hover:not(:disabled) {
            background: #00b248;
        }

        .step-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #ebebeb;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        .code-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-size: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <!-- Entry Page -->
    <div id="entry-page">
        <h1 class="entry-title">Select a Picture to Start From</h1>
        <div class="preview-grid" id="preview-grid"></div>
    </div>

    <!-- Main Container -->
    <div class="container" id="main-container">
        <div class="left-panel">
            <div class="section">
                <div class="section-label">Thought</div>
                <div class="thought-content" id="thought-content"></div>
            </div>
            <div class="separator"></div>
            <div class="section code-section">
                <div class="section-label">Code (Python)</div>
                <div class="code-container">
                    <div class="code-content" id="code-content"></div>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="step-indicator" id="step-indicator">Step 0</div>
            <div class="right-panel-top">
                <div class="right-panel-top-left">
                    <div class="image-container" id="image-container-original"></div>
                </div>
                <div class="right-panel-top-right">
                    <div class="image-container" id="image-container-top"></div>
                </div>
            </div>
            <div class="right-panel-bottom">
                <div class="image-container" id="image-container-bottom">
                    <div class="loading-container">
                        <img src="https://i.stack.imgur.com/ATB3o.gif" alt="Loading" class="loading-gif" id="loading-gif">
                        <div class="loading-text">Generating...</div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-Investigate" id="Investigate-btn" onclick="pauseAtIntegration()" disabled>Investigate</button>
                <button class="btn btn-resume" id="resume-btn" onclick="resume()" style="display: none;">Resume</button>
            </div>
            <div class="download-blender-btn">
                <button class="btn" id="download-blender-btn" onclick="downloadBlenderFile()" disabled>Download Blender</button>
            </div>
        </div>
    </div>

    <script>
        let currentStepIndex = -1;
        let totalSteps = 0;
        let stepsData = [];
        let isTyping = false;
        let isPaused = false;
        let autoAdvanceTimeout = null;
        let selectedStartIndex = 0;
        let codeGenerated = false;
        let imageLoaded = false;
        let typingTimeout = null;
        let currentStepHasBlend = false;

        // Entry page initialization
        async function initEntryPage() {
            try {
                const response = await fetch('/api/preview-images');
                const data = await response.json();
                const grid = document.getElementById('preview-grid');
                
                if (data.images.length === 0) {
                    grid.innerHTML = '<div style="color: #888;">No preview images available</div>';
                    return;
                }

                // Display up to 10 images
                const imagesToShow = data.images.slice(0, 10);
                imagesToShow.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    const img = document.createElement('img');
                    img.src = `${item.image_url}?t=${Date.now()}`;
                    img.alt = item.is_target ? (item.scene_name || 'Target Image') : `Step ${item.step_index}`;
                    div.appendChild(img);
                    // For target images, load trajectory first, then start from step 0
                    if (item.is_target && item.scene_name) {
                        div.onclick = () => startFromScene(item.scene_name);
                    } else {
                        div.onclick = () => startFromStep(item.is_target ? 0 : item.step_index);
                    }
                    grid.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading preview images:', error);
                document.getElementById('preview-grid').innerHTML = 
                    '<div style="color: #ff4444;">Error loading preview images</div>';
            }
        }

        async function startFromScene(sceneName) {
            // Load trajectory for the selected scene
            try {
                const response = await fetch(`/api/load-trajectory/${sceneName}`);
                const data = await response.json();
                if (data.success) {
                    // Store the original target image URL
                    originalTargetImageUrl = `/api/target-image/${sceneName}?t=${Date.now()}`;
                    // Load and display the original target image in the left side of top panel
                    loadOriginalTargetImage();
                    
                    selectedStartIndex = 0;
                    document.getElementById('entry-page').style.display = 'none';
                    document.getElementById('main-container').style.display = 'flex';
                    init();
                } else {
                    alert(`Error loading trajectory: ${data.error}`);
                }
            } catch (error) {
                console.error('Error loading trajectory:', error);
                alert(`Error loading trajectory: ${error.message}`);
            }
        }

        function loadOriginalTargetImage() {
            if (!originalTargetImageUrl) return;
            const container = document.getElementById('image-container-original');
            container.innerHTML = '';
            const img = document.createElement('img');
            img.src = originalTargetImageUrl;
            img.onerror = () => {
                container.innerHTML = '<div class="loading">Original image not available</div>';
            };
            container.appendChild(img);
        }

        function startFromStep(stepIndex) {
            selectedStartIndex = stepIndex;
            document.getElementById('entry-page').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            init();
        }

        // Initialize main page
        async function init() {
            try {
                const response = await fetch('/api/steps');
                const data = await response.json();
                totalSteps = data.total_steps;
                stepsData = data.steps;
                
                if (totalSteps > 0) {
                    currentStepIndex = selectedStartIndex - 1; // Will be incremented in loadStep
                    updateStepIndicator();
                    // Auto-start first step
                    loadStep(selectedStartIndex);
                } else {
                    document.getElementById('thought-content').textContent = 'No steps found in trajectory.';
                }
            } catch (error) {
                console.error('Error loading steps:', error);
                document.getElementById('thought-content').textContent = 'Error loading trajectory data.';
            }
        }

        function updateStepIndicator() {
            document.getElementById('step-indicator').textContent = 
                `Step ${currentStepIndex + 1}`;
        }

        async function loadStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= totalSteps) {
                return;
            }

            currentStepIndex = stepIndex;
            updateStepIndicator();
            codeGenerated = false;
            imageLoaded = false;

            // Clear auto-advance timeout
            if (autoAdvanceTimeout) {
                clearTimeout(autoAdvanceTimeout);
                autoAdvanceTimeout = null;
            }

            try {
                // Clear all content first to maintain consistent layout
                document.getElementById('thought-content').innerHTML = '';
                document.getElementById('code-content').innerHTML = '';
                document.getElementById('image-container-top').innerHTML = '';
                // Keep original target image visible (don't clear image-container-original)
                showBottomLoading();

                const response = await fetch(`/api/step/${stepIndex}`);
                const step = await response.json();

                // If not the first step, load previous step image to top
                if (stepIndex > 0) {
                    await loadPreviousStepImage(stepIndex - 1);
                }

                // Reset buttons
                document.getElementById('Investigate-btn').disabled = true;
                document.getElementById('Investigate-btn').style.display = 'block';
                document.getElementById('resume-btn').style.display = 'none';
                // Update download blender button state
                currentStepHasBlend = step.has_blend || false;
                document.getElementById('download-blender-btn').disabled = !currentStepHasBlend;
                isPaused = false;

                // Type thought character by character
                await typeThought(step.thought);

                // Display code line by line (after thought is done)
                await displayCode(step.code);
                codeGenerated = true;

                // Enable Investigate button after code is displayed
                document.getElementById('Investigate-btn').disabled = false;

                // Wait 1 second after code, then load image
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Load image
                if (step.has_video) {
                    await loadVideo(stepIndex, 'bottom');
                } else if (step.has_image) {
                    await loadImage(stepIndex, 'bottom');
                }
                imageLoaded = true;

                // Auto advance after 3 seconds (unless paused)
                if (!isPaused) {
                    autoAdvanceTimeout = setTimeout(() => {
                        if (currentStepIndex < totalSteps - 1 && !isPaused) {
                            loadStep(currentStepIndex + 1);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error loading step:', error);
                document.getElementById('thought-content').textContent = 'Error loading step data.';
            }
        }

        async function loadPreviousStepImage(stepIndex) {
            try {
                const response = await fetch(`/api/step/${stepIndex}`);
                const step = await response.json();
                if (step.has_image) {
                    await loadImage(stepIndex, 'top');
                }
            } catch (error) {
                console.error('Error loading previous step image:', error);
            }
        }

        function showBottomLoading() {
            const container = document.getElementById('image-container-bottom');
            container.innerHTML = `
                <div class="loading-container">
                    <img src="https://i.stack.imgur.com/ATB3o.gif" alt="Loading" class="loading-gif">
                    <div class="loading-text">Generating...</div>
                </div>
            `;
        }

        async function typeThought(text) {
            isTyping = true;
            const thoughtEl = document.getElementById('thought-content');
            thoughtEl.innerHTML = '';
            
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            thoughtEl.appendChild(cursor);

            for (let i = 0; i < text.length; i++) {
                if (!isTyping || isPaused) break;
                
                cursor.remove();
                thoughtEl.textContent += text[i];
                thoughtEl.appendChild(cursor);
                
                // Typing speed: 10ms for spaces/newlines, 25ms for other characters
                const delay = (text[i] === ' ' || text[i] === '\n') ? 10 : 25;
                await new Promise(resolve => setTimeout(resolve, delay));
            }

            cursor.remove();
            isTyping = false;
        }

        async function displayCode(code) {
            const codeEl = document.getElementById('code-content');
            codeEl.innerHTML = '';
            
            // Create DOM structure once
            const pre = document.createElement('pre');
            const codeBlock = document.createElement('code');
            codeBlock.className = 'language-python';
            pre.appendChild(codeBlock);
            codeEl.appendChild(pre);
            
            // Split code into lines
            const lines = code.split('\n');
            let accumulatedCode = '';
            
            // Display code line by line without recreating DOM
            for (let i = 0; i < lines.length; i++) {
                if (isPaused) break; // Allow interruption
                
                // Add current line
                if (i > 0) {
                    accumulatedCode += '\n';
                }
                accumulatedCode += lines[i];
                
                // Update text content directly (no DOM recreation to avoid flickering)
                codeBlock.textContent = accumulatedCode;
                
                // Delay between lines
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Final highlight only once at the end (avoids flickering)
            if (!isPaused) {
                hljs.highlightElement(codeBlock);
            }
        }

        async function loadImage(stepIndex, position) {
            const containerId = position === 'top' ? 'image-container-top' : 'image-container-bottom';
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = `/api/image/${stepIndex}?t=${Date.now()}`;
            img.onerror = () => {
                container.innerHTML = '<div class="loading">Image not available</div>';
            };
            container.appendChild(img);
        }

        async function loadVideo(stepIndex, position) {
            const containerId = position === 'top' ? 'image-container-top' : 'image-container-bottom';
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const video = document.createElement('video');
            video.src = `/api/video/${stepIndex}?t=${Date.now()}`;
            video.controls = true;
            video.autoplay = true;
            video.loop = true;
            video.onerror = () => {
                container.innerHTML = '<div class="loading">Video not available</div>';
            };
            container.appendChild(video);
        }

        function pauseAtIntegration() {
            isPaused = true;
            isTyping = false;
            if (autoAdvanceTimeout) {
                clearTimeout(autoAdvanceTimeout);
                autoAdvanceTimeout = null;
            }
            document.getElementById('Investigate-btn').style.display = 'none';
            document.getElementById('resume-btn').style.display = 'block';
        }

        function resume() {
            isPaused = false;
            document.getElementById('Investigate-btn').style.display = 'block';
            document.getElementById('resume-btn').style.display = 'none';
            
            // If code and image are both loaded, auto advance in 3 seconds
            if (codeGenerated && imageLoaded) {
                autoAdvanceTimeout = setTimeout(() => {
                    if (currentStepIndex < totalSteps - 1 && !isPaused) {
                        loadStep(currentStepIndex + 1);
                    }
                }, 3000);
            } else {
                // Otherwise, continue with current step loading
                loadStep(currentStepIndex);
            }
        }

        function downloadBlenderFile() {
            if (currentStepIndex < 0 || currentStepIndex >= totalSteps || !currentStepHasBlend) {
                return;
            }
            
            // Create a temporary anchor element to trigger download
            const link = document.createElement('a');
            link.href = `/api/blend/${currentStepIndex}`;
            link.download = `state_step_${currentStepIndex + 1}.blend`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize entry page on load
        window.addEventListener('DOMContentLoaded', () => {
            initEntryPage();
        });
    </script>
</body>
</html>
